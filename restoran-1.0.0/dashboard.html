<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Hotel Dashboard</title>
    <link href="https://img.icons8.com/ios-glyphs/30/FEA116/company.png" rel="icon">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&family=Pacifico&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">

    <!-- Custom Dashboard CSS -->
    <style>
        .dashboard-container {
            padding: 50px 0;
        }

        .welcome-card {
            background-color: #FEA116; /* Primary color */
            color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer; /* Added for click indication */
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .back-btn {
            background: linear-gradient(135deg, #FEA116, #FEA116);
            color: white !important; /* Ensure text is white */
            border: none;
            padding: 10px 20px; /* Adjusted padding */
            border-radius: 8px;
            font-size: 14px; /* Increased font size */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 14px 0 rgba(254, 161, 22, 0.4);
            margin-top: 20px; /* Adjusted margin */
            margin-bottom: 20px;
            display: inline-block;
            text-decoration: none; /* For <a> tag */
        }
        .back-btn:hover {
            background: linear-gradient(135deg, #e48f0f, #e48f0f); /* Darker shade on hover */
            color: white !important;
            text-decoration: none;
        }

        .stats-icon {
            font-size: 24px; /* Updated from 2.5rem */
            color: #FEA116;
            margin-bottom: 10px;
        }

        .stats-number {
            font-size: 24px; /* Updated from 2rem */
            font-weight: bold;
            margin: 10px 0; /* Added margin */
        }
        .stats-label { /* Added from original to ensure it's present if needed */
            font-size: 0.9rem;
            color: #6c757d;
        }

        .recent-activity {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            padding: 15px 0; /* Adjusted from padding-bottom and margin-bottom */
            border-bottom: 1px solid #eee;
            display: flex; /* Added to align icon and content */
            align-items: center; /* Added to align icon and content */
        }

        .activity-item:last-child {
            border-bottom: none;
            padding-bottom: 0; /* Remove padding for last item to avoid extra space */
        }
         .activity-item:first-of-type { /* For dynamic content, ensure first item top padding is consistent */
            padding-top: 0;
        }

        .activity-icon {
            background-color: #f8f9fa; /* Default background */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        .activity-icon i {
            color: #FEA116; /* Default icon color */
        }

        .activity-content h6 {
            margin-bottom: 5px;
            font-weight: 600;
        }
         .activity-content p {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 12px; /* Updated from 0.8em */
            color: #6c757d;
        }

        .user-profile {
            text-align: center;
            margin-bottom: 30px; /* Increased margin */
            background-color: #fff; /* Added from original */
            padding: 20px; /* Added from original */
            border-radius: 8px; /* Added from original, new CSS doesn't specify for user-profile directly */
            box-shadow: 0 0 15px rgba(0,0,0,0.1); /* Added from original */
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            border: 3px solid #FEA116;
            overflow: hidden;
        }

        .user-avatar i {
            font-size: 40px;
            color: #FEA116;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .quick-actions {
            margin-top: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .action-btn {
            display: block;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            position: relative;
        }

        .action-btn:hover {
            background-color: #FEA116;
            color: white;
        }

        .action-btn i, .action-btn .logout-icon {
            margin-right: 10px;
        }
        .logout-icon i {
             color: #dc3545 !important;
        }
        .action-btn:hover .logout-icon i {
            color: white !important;
        }

        .cart-badge {
            font-size: 0.65em;
            padding: 0.25em 0.5em;
            line-height: 1;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .booking-item img.booking-hotel-image {
            width:100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 12px;
        }
        .booking-item img.booking-room-image {
            width: 100px;
            height: auto;
            border-radius: 4px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .booking-item h6 {
            color: #FEA116;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .booking-item p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.3rem;
        }
        .booking-item .booking-details-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        #bookingFilterControls .btn.active,
        #bookingFilterControls .btn-outline-primary.active {
            background-color: #FEA116;
            color: white;
            border-color: #FEA116;
        }
        #bookingFilterControls .btn {
             margin: 0 5px;
        }
        .badge.bg-success, .badge.bg-danger, .badge.bg-warning, .badge.bg-info { /* Added bg-info */
            font-size: 0.85em;
        }

        /* Payment Method Offcanvas Styling */
        #paymentMethodsOffcanvas .list-group-item i.fab,
        #paymentMethodsOffcanvas .list-group-item i.bi { /* Card and other payment icons */
            color: #0d6efd; /* Bootstrap primary blue, or use #FEA116 or specific colors */
        }
        #paymentMethodsOffcanvas .list-group-item .btn-outline-danger i { /* Trash icon color */
             color: #dc3545;
        }
         #paymentMethodsOffcanvas .list-group-item .btn-outline-danger:hover i {
             color: white;
        }
        #paymentMethodsOffcanvas .list-group-item-action .text-primary {
            color: #FEA116 !important;
        }
        #paymentTypeSelectionContainer .list-group-item-action {
            margin-bottom: 10px;
            border-radius: .25rem;
        }
        #paymentTypeSelectionContainer .list-group-item-action i {
            width: 20px; /* Align icons */
            text-align: center;
        }
    </style>

</head>

<body>
    <div class="container-xxl bg-white p-0">
        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->

        <!-- Navbar (Simplified for dashboard context, or you can remove it if dashboard is standalone) -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4 px-lg-5 py-3 py-lg-0">
            <a href="index.html" class="navbar-brand p-0">
                <h1 class="text-primary m-0"><i class="bi-building me-3"></i>Hotel Dashboard</h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapseDashboard">
                <span class="fa fa-bars"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapseDashboard">
                <div class="navbar-nav ms-auto py-0 pe-4">
                    <a href="index.html" class="nav-item nav-link">Main Site Home</a>
                    <a href="menu.html" class="nav-item nav-link">Order Food</a>
                </div>
            </div>
        </nav>
        <!-- Navbar End -->


        <!-- Dashboard Start -->
        <div class="container-xxl py-5 dashboard-container">
            <div class="container">
                <div class="row g-4">
                    <!-- Left Column - User Profile and Quick Actions -->
                    <div class="col-lg-4">
                    <a href="javascript:history.back()" class="back-btn"><i class="fas fa-arrow-left me-2"></i>Back</a>
                    <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i> <!-- Fallback icon -->
                    </div>
                        <h4 id="user-name">User</h4>
                        <p class="text-muted">Premium Member</p>
                    </div>

                        <div class="quick-actions">
                            <h5 class="mb-3">Quick Actions</h5>
                            <a href="#" id="myBookingsLink" class="action-btn">
                                <i class="far fa-calendar-alt"></i> My Bookings
                           </a>
                            <a href="menu.html" class="action-btn">
                                <i class="fas fa-utensils"></i> Order Food
                            </a>
                            <a href="profile.html" class="action-btn">
                                <i class="fas fa-user-edit"></i> Edit Profile
                            </a>
                            <a href="#" class="action-btn" id="viewCartBtn"> <!-- ID for cart button -->
                                <i class="bi bi-cart-fill"></i> Cart
                                <!-- Badge will be added here by JS -->
                            </a>
                            <a href="#" class="action-btn" data-bs-toggle="offcanvas" data-bs-target="#paymentMethodsOffcanvas" aria-controls="paymentMethodsOffcanvas">
                                <i class="fas fa-credit-card"></i> Payment Methods
                            </a>
                            <a href="contact.html" class="action-btn">
                                <i class="fas fa-headset"></i> Customer Support
                            </a>
                            <a href="#" class="action-btn" id="logoutLink"> <!-- ID for logout -->
                                <span class="logout-icon">
                                    <i class="bi bi-box-arrow-right"></i>
                                </span>
                                Logout
                            </a>
                        </div>
                    </div>

                    <!-- Right Column - Dashboard Content -->
                    <div class="col-lg-8">
                        <div class="welcome-card">
                            <h3 id="welcome-message">Welcome back!</h3>
                            <p>Track your orders, manage your bookings, and explore our newest menu items.</p>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-4">
                                <div class="stats-card text-center" id="foodOrdersStatsCard"> <!-- ID Added -->
                                    <div class="stats-icon">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                    <div class="stats-number" id="ordersPlacedStat">00</div>
                                    <div class="stats-label">Food Orders Placed</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                 <div class="stats-card text-center" id="reservationsStatsCard"> <!-- ID Added -->
                                    <div class="stats-icon">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div class="stats-number" id="reservationsStat">00</div>
                                    <div class="stats-label">Room Reservations</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card text-center">
                                    <div class="stats-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="stats-number" id="loyaltyPointsStat">00</div>
                                    <div class="stats-label">Loyalty Points</div>
                                </div>
                            </div>
                        </div>

                        <div class="recent-activity">
                            <h5 class="mb-4">Recent Activity</h5>
                            <!-- Dynamic activity items will be injected here by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Dashboard End -->

        <!-- My Bookings Modal START -->
        <div class="modal fade" id="myBookingsModal" tabindex="-1" aria-labelledby="myBookingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="myBookingsModalLabel"><i class="far fa-calendar-alt text-primary me-2"></i>My Hotel Bookings</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- START: Filter buttons -->
                        <div class="mb-3 d-flex justify-content-center btn-group" role="group" id="bookingFilterControls">
                            <button type="button" class="btn btn-outline-primary active" data-filter="all">All Bookings</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="active">Active</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="cancelled">Cancelled</button>
                        </div>
                        <!-- END: Filter buttons -->
                        <div id="bookingsListModalContainer">
                            <p class="text-center text-muted">Loading bookings...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- My Bookings Modal END -->


        <!-- Food Cart Modal -->
        <div class="modal fade" id="foodCartModal" tabindex="-1" aria-labelledby="foodCartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="foodCartModalLabel"><i class="bi bi-cart-fill text-primary me-2"></i>Your Food Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="cartItemsContainer">
                            <p class="text-center text-muted">Your cart is empty. <a href="menu.html" class="text-primary">Order some food!</a></p>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label for="roomNumberInput" class="form-label fw-bold">Room Number for Delivery:</label>
                            <input type="text" class="form-control" id="roomNumberInput" placeholder="Enter your room number" required>
                        </div>
                        <div class="text-end">
                            <h4>Total: ₹<span id="cartTotalAmount">0.00</span></h4>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
                        <button type="button" class="btn btn-primary" id="checkoutCartButton"><i class="fas fa-concierge-bell me-2"></i>Place Order for Room</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Food Cart Modal END -->

        <!-- My Food Orders Modal START -->
        <div class="modal fade" id="myFoodOrdersModal" tabindex="-1" aria-labelledby="myFoodOrdersModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="myFoodOrdersModalLabel"><i class="fas fa-utensils text-primary me-2"></i>My Food Orders</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="foodOrdersListContainer">
                            <p class="text-center text-muted">Loading food orders...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- My Food Orders Modal END -->

        <!-- Payment Methods Offcanvas Start -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="paymentMethodsOffcanvas" aria-labelledby="paymentMethodsOffcanvasLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="paymentMethodsOffcanvasTitleContainer">
                    <button type="button" class="btn btn-link p-0 me-2 d-none" id="backToPaymentTypesBtn" style="vertical-align: middle; font-size: 1.2rem;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span id="offcanvasDynamicTitle" style="vertical-align: middle;">Select Payment Method</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <!-- Payment Type Selection View -->
                <div id="paymentTypeSelectionContainer">
                    <p class="mb-3">Choose how you'd like to pay or manage your payment options:</p>
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="cards">
                            <i class="fas fa-credit-card me-2 text-primary"></i> Credit/Debit Cards
                            <small class="d-block text-muted mt-1">Manage your saved cards or add a new one.</small>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="upi">
                            <i class="bi bi-lightning-charge-fill me-2" style="color: #57398E;"></i> UPI
                            <small class="d-block text-muted mt-1">Pay directly using UPI ID (e.g., GPay, PhonePe).</small>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="netbanking">
                            <i class="fas fa-university me-2" style="color: #28a745;"></i> Net Banking
                            <small class="d-block text-muted mt-1">Use your internet banking facility.</small>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="wallets">
                            <i class="fas fa-wallet me-2" style="color: #DD3682;"></i> Digital Wallets
                            <small class="d-block text-muted mt-1">Pay with popular mobile wallets (e.g., Paytm).</small>
                        </a>
                    </div>
                </div>

                <!-- Credit/Debit Card Management View -->
                <div id="creditCardManagementContainer" style="display: none;">
                    <div id="savedPaymentMethodsContainer">
                        <!-- Saved payment methods will be loaded here -->
                        <p class="text-muted text-center">No payment methods saved yet.</p>
                    </div>
                    <hr>
                    <button class="btn btn-primary w-100 mb-3" type="button" id="showAddPaymentMethodFormBtn">
                        <i class="fas fa-plus-circle me-2"></i>Add New Card
                    </button>
                    <div id="addPaymentMethodFormContainer" style="display: none;">
                        <h5 class="mb-3">Add New Card</h5>
                        <form id="addPaymentMethodForm">
                            <div class="mb-3">
                                <label for="cardholderName" class="form-label">Cardholder Name</label>
                                <input type="text" class="form-control" id="cardholderName" required>
                            </div>
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" required maxlength="19" inputmode="numeric">
                            </div>
                            <div class="row">
                                <div class="col-md-7 mb-3">
                                    <label for="cardExpiry" class="form-label">Expiry Date (MM/YY)</label>
                                    <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" required maxlength="5">
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label for="cardCvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cardCvv" placeholder="XXX" required maxlength="4" inputmode="numeric">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Add Card</button>
                            <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="cancelAddPaymentMethodBtn">Cancel</button>
                        </form>
                    </div>
                </div>

                <!-- Placeholder for other payment types -->
                <div id="otherPaymentMethodPlaceholder" style="display: none;" class="text-center p-3">
                    <h5 id="otherPaymentMethodTitle" class="mb-3"></h5>
                    <i id="otherPaymentMethodIcon" class="display-4 mb-3"></i>
                    <p id="otherPaymentMethodMessage" class="text-muted">This payment option is currently under development and will be available soon. We appreciate your patience!</p>
                    <p class="text-muted small">Please select another payment method or check back later.</p>
                </div>
            </div>
        </div>
        <!-- Payment Methods Offcanvas End -->


        <!-- Footer Start -->
        <div class="container-fluid bg-dark text-light footer pt-5 mt-5 wow fadeIn" data-wow-delay="0.1s">
            <div class="container py-5">
                <div class="row g-5">
                    <div class="col-lg-3 col-md-6">
                        <h4 class="section-title ff-secondary text-start text-primary fw-normal mb-4">Company</h4>
                        <a class="btn btn-link" href="about.html">About Us</a>
                        <a class="btn btn-link" href="contact.html">Contact Us</a>
                        <a class="btn btn-link" href="booking.html">Reservation</a>
                        <a class="btn btn-link" href="#">Privacy Policy</a>
                        <a class="btn btn-link" href="#">Terms & Condition</a>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <h4 class="section-title ff-secondary text-start text-primary fw-normal mb-4">Contact</h4>
                        <p class="mb-2"><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                        <p class="mb-2"><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                        <p class="mb-2"><i class="fa fa-envelope me-3"></i>info@example.com</p>
                        <div class="d-flex pt-2">
                            <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-twitter"></i></a>
                            <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-facebook-f"></i></a>
                            <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-youtube"></i></a>
                            <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-linkedin-in"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <h4 class="section-title ff-secondary text-start text-primary fw-normal mb-4">Opening</h4>
                        <h5 class="text-light fw-normal">Monday - Saturday</h5>
                        <p>09AM - 09PM</p>
                        <h5 class="text-light fw-normal">Sunday</h5>
                        <p>10AM - 08PM</p>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <h4 class="section-title ff-secondary text-start text-primary fw-normal mb-4">Newsletter</h4>
                        <p>Subscribe to our newsletter for updates.</p>
                        <div class="position-relative mx-auto" style="max-width: 400px;">
                            <input class="form-control border-primary w-100 py-3 ps-4 pe-5" type="text" placeholder="Your email">
                            <button type="button" class="btn btn-primary py-2 position-absolute top-0 end-0 mt-2 me-2">SignUp</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="copyright">
                    <div class="row">
                        <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                            © <a class="border-bottom" href="#">Your Site Name</a>, All Right Reserved.
                        </div>
                        <div class="col-md-6 text-center text-md-end">
                            <div class="footer-menu">
                                <a href="index.html">Home</a>
                                <a href="#">Cookies</a>
                                <a href="#">Help</a>
                                <a href="#">FQAs</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->

        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- Additional Dashboard Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        if (!currentUser) {
            console.warn('User not logged in. Dashboard functionality will be limited.');
            // Optional: Redirect to login page if essential
            // window.location.href = 'login.html';
        }

        // --- Helper function to update booking statuses ---
        function updateAndRefreshBookingStatuses(userEmail) {
            if (!userEmail) return false;

            const userBookingsKey = `userBookings_${userEmail}`;
            let bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];
            let statusesUpdated = false;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to compare with checkOutDate at midnight

            bookings = bookings.map(booking => {
                if (booking.status === 'Confirmed' && booking.checkOutDate) {
                    const checkOutDateObj = new Date(booking.checkOutDate);
                    // Create a date object for the checkout date at local midnight for accurate comparison
                    const checkOutDateNormalized = new Date(checkOutDateObj.getFullYear(), checkOutDateObj.getMonth(), checkOutDateObj.getDate());

                    // If checkOutDate is strictly before today, the stay is completed
                    if (checkOutDateNormalized < today) {
                        booking.status = 'Completed'; // New status for past confirmed bookings
                        statusesUpdated = true;
                        // Optionally, add a completionTimestamp if needed for other features
                        // booking.completionTimestamp = new Date().toISOString();
                    }
                }
                return booking;
            });

            if (statusesUpdated) {
                localStorage.setItem(userBookingsKey, JSON.stringify(bookings));
                console.log('Booking statuses updated in localStorage.');
            }
            return statusesUpdated;
        }
        // --- End Helper function ---

        // Initial call to update statuses if user is logged in
        // This should happen BEFORE any function reads booking data for display or calculation
        if (currentUser && currentUser.email) {
            updateAndRefreshBookingStatuses(currentUser.email);
        }


        const userNameElement = document.getElementById('user-name');
        if (userNameElement && currentUser) userNameElement.textContent = currentUser.name;

        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage && currentUser) welcomeMessage.textContent = `Welcome back, ${currentUser.name}!`;

        if (currentUser && currentUser.email) {
            const profileData = JSON.parse(localStorage.getItem('userProfileData_' + currentUser.email)) || {};
            const userAvatar = document.querySelector('.user-avatar');

            if (userAvatar) {
                if (profileData.profileImage) {
                    userAvatar.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = profileData.profileImage;
                    img.alt = 'Profile Photo';
                    userAvatar.appendChild(img);
                }
            }
        }


        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html'; // Or your login page
                alert('You have been logged out successfully');
            });
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            // Check if the date string includes time information (ISO format usually does)
            if (dateString.includes('T') && dateString.includes('Z')) { // Likely an ISO string with time
                 return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric'}) + ' ' + date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            }
            // If not, assume it's just a date and format accordingly
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatRelativeTime(date) {
            if (!date) return 'N/A';
            return moment(date).fromNow();
        }

        function displayRecentActivities(userEmail) {
            const recentActivityContainer = document.querySelector('.recent-activity');
            if (!recentActivityContainer) {
                console.error("Recent activity container not found.");
                return;
            }

            // Clear only activity items, not the "Recent Activity" title
            const existingItems = recentActivityContainer.querySelectorAll('.activity-item, .no-activity-message, h5 ~ *'); // Selects all children after h5
            existingItems.forEach(item => item.remove());


            if (!userEmail) {
                 const noActivityItem = document.createElement('div');
                noActivityItem.className = 'activity-item text-muted text-center py-3 no-activity-message';
                noActivityItem.textContent = 'Login to see your recent activity.';
                noActivityItem.style.borderBottom = 'none'; // Ensure no border for this message
                recentActivityContainer.appendChild(noActivityItem);
                return;
            }

            const userBookingsKey = `userBookings_${userEmail}`;
            const bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];
            const userFoodOrdersKey = `foodOrders_${userEmail}`;
            const foodOrders = JSON.parse(localStorage.getItem(userFoodOrdersKey)) || [];

            let activities = [];

            bookings.forEach(booking => {
                // Activity for booking confirmation or completion
                if (booking.status === 'Confirmed' || booking.status === 'Completed') {
                     activities.push({
                        type: 'booking_confirmed', // Keep type generic, or differentiate if needed
                        timestamp: new Date(booking.bookingDate),
                        title: `Room Booking #${booking.bookingRef}`,
                        description: `Booking for ${booking.roomType || 'room'} at ${booking.hotelName || 'hotel'} is ${booking.status.toLowerCase()}.`,
                        iconClass: booking.status === 'Completed' ? 'fas fa-check-circle' : 'fas fa-bed',
                        iconBgColor: booking.status === 'Completed' ? '#198754' : '#28a745', // Darker green for completed
                        iconColor: 'white'
                    });
                }


                if (booking.status === 'Cancelled' && booking.cancellationTimestamp) {
                    activities.push({
                        type: 'booking_cancelled',
                        timestamp: new Date(booking.cancellationTimestamp),
                        title: `Booking Cancelled: #${booking.bookingRef}`,
                        description: `Your booking for ${booking.roomType || 'the room'} was cancelled.`,
                        iconClass: 'fas fa-calendar-times',
                        iconBgColor: '#dc3545', // Red for cancelled
                        iconColor: 'white'
                    });
                }
            });

            foodOrders.forEach(order => {
                let description = `Your food order (Total: ₹${order.totalAmount.toFixed(2)})`;
                if (order.mealType) {
                    description += ` for ${order.mealType}`;
                }
                if (order.roomNumber) {
                    description += ` to Room ${order.roomNumber}`;
                }
                description += ` has been placed. Status: ${order.status || 'Processing'}`;

                activities.push({
                    type: 'food_order_placed',
                    timestamp: new Date(order.orderDate),
                    title: `Food Order Placed`,
                    description: description,
                    iconClass: 'fas fa-utensils',
                    iconBgColor: 'rgba(254, 161, 22, 0.15)', // Light orange background
                    iconColor: '#FEA116' // Primary orange icon
                });
            });

            // Sort activities by timestamp, most recent first
            activities.sort((a, b) => b.timestamp - a.timestamp);

            const maxActivitiesToShow = 5; // Show up to 5 recent activities
            const recentActivitiesToDisplay = activities.slice(0, maxActivitiesToShow);

            if (recentActivitiesToDisplay.length === 0) {
                const noActivityItem = document.createElement('div');
                noActivityItem.className = 'activity-item text-muted text-center py-3 no-activity-message';
                noActivityItem.textContent = 'No recent activity to display.';
                noActivityItem.style.borderBottom = 'none'; // Ensure no border for this message
                recentActivityContainer.appendChild(noActivityItem);
                return;
            }

            recentActivitiesToDisplay.forEach((activity) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'activity-item d-flex align-items-center'; // Ensure alignment

                const iconDiv = document.createElement('div');
                iconDiv.className = 'activity-icon';
                if (activity.iconBgColor) iconDiv.style.backgroundColor = activity.iconBgColor;

                const iconI = document.createElement('i');
                iconI.className = activity.iconClass;
                if (activity.iconColor) iconI.style.color = activity.iconColor;

                iconDiv.appendChild(iconI);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'activity-content';

                const titleH6 = document.createElement('h6');
                titleH6.textContent = activity.title;

                const descP = document.createElement('p');
                descP.innerHTML = activity.description; // Use innerHTML if description might contain simple HTML like <strong>

                const timeDiv = document.createElement('div');
                timeDiv.className = 'activity-time';
                timeDiv.textContent = formatRelativeTime(activity.timestamp);

                contentDiv.appendChild(titleH6);
                contentDiv.appendChild(descP);
                contentDiv.appendChild(timeDiv);

                itemDiv.appendChild(iconDiv);
                itemDiv.appendChild(contentDiv);

                recentActivityContainer.appendChild(itemDiv);
            });
        }

        // --- Loyalty Points Feature ---
        const loyaltyPointsStat = document.getElementById('loyaltyPointsStat');

        function calculateAndDisplayLoyaltyPoints(userEmail) {
            if (!loyaltyPointsStat) return;

            if (!userEmail) {
                loyaltyPointsStat.textContent = '00';
                return;
            }

            const userBookingsKey = `userBookings_${userEmail}`;
            const bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];

            let totalPoints = 0;
            const POINTS_PER_CONFIRMED_OR_COMPLETED_BOOKING = 10; 

            bookings.forEach(booking => {
                // Award points for bookings that were confirmed, even if now completed
                if (booking.status === 'Confirmed' || booking.status === 'Completed') {
                    totalPoints += POINTS_PER_CONFIRMED_OR_COMPLETED_BOOKING;
                }
            });

            loyaltyPointsStat.textContent = totalPoints.toString().padStart(2, '0');
        }


        // --- My Bookings Feature ---
        const myBookingsLink = document.getElementById('myBookingsLink');
        const bookingsListContainer = document.getElementById('bookingsListModalContainer');
        const reservationsStat = document.getElementById('reservationsStat');
        const myBookingsModalEl = document.getElementById('myBookingsModal');
        const bookingFilterControls = document.getElementById('bookingFilterControls');
        let myBookingsModalInstance;

        if (myBookingsModalEl) {
            myBookingsModalInstance = new bootstrap.Modal(myBookingsModalEl);
        }

        function isBookingCancellable(checkInDateString) {
            if (!checkInDateString) return false;
            const checkInDate = new Date(checkInDateString);
            const now = new Date();
            const fortyEightHoursInMs = 2 * 24 * 60 * 60 * 1000;
            return (checkInDate.getTime() - now.getTime()) > fortyEightHoursInMs;
        }

        function handleCancelBooking(bookingRef, userEmail) {
            if (!confirm(`Are you sure you want to cancel booking ${bookingRef}? This action cannot be undone.`)) {
                return;
            }

            const userBookingsKey = `userBookings_${userEmail}`;
            let bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];
            const bookingIndex = bookings.findIndex(b => b.bookingRef === bookingRef);

            if (bookingIndex > -1) {
                if (bookings[bookingIndex].status !== 'Confirmed' || !isBookingCancellable(bookings[bookingIndex].checkInDate)) {
                    alert('This booking is no longer eligible for cancellation or has already been processed.');
                    const currentFilter = document.querySelector('#bookingFilterControls .btn.active').dataset.filter || 'all';
                    displayUserBookings(userEmail, currentFilter); // Re-render to show current state
                    return;
                }
                bookings[bookingIndex].status = 'Cancelled';
                bookings[bookingIndex].cancellationTimestamp = new Date().toISOString(); // Record cancellation time
                localStorage.setItem(userBookingsKey, JSON.stringify(bookings));
                alert('Booking cancelled successfully.');

                const currentFilter = document.querySelector('#bookingFilterControls .btn.active').dataset.filter || 'all';
                displayUserBookings(userEmail, currentFilter); 

                calculateAndDisplayLoyaltyPoints(userEmail); // Recalculate loyalty points
                if (currentUser && currentUser.email) {
                    displayRecentActivities(currentUser.email);
                }
            } else {
                alert('Error: Booking not found.');
            }
        }

        function displayUserBookings(userEmail, filterType = 'all') {
            if (!bookingsListContainer) return;
            // The updateAndRefreshBookingStatuses() has already run once globally.
            // No need to call it again here unless there's a specific reason for re-evaluation within this scope.

            bookingsListContainer.innerHTML = ''; // Clear previous bookings
            if (!userEmail) {
                bookingsListContainer.innerHTML = '<p class="text-danger text-center">User not identified. Please log in.</p>';
                if(reservationsStat) reservationsStat.textContent = '00';
                return;
            }
            const userBookingsKey = `userBookings_${userEmail}`;
            const allBookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];

            let filteredBookings = allBookings;
            if (filterType === 'active') {
                // "Active" means 'Confirmed' and not yet 'Completed' (i.e., check-out date is today or future)
                filteredBookings = allBookings.filter(b => b.status === 'Confirmed');
            } else if (filterType === 'cancelled') {
                filteredBookings = allBookings.filter(b => b.status === 'Cancelled');
            }
            // 'all' filter shows everything, including 'Completed'

            // Update reservations stat with the count of *currently active* 'Confirmed' bookings
            if (reservationsStat) {
                const activeBookingsCount = allBookings.filter(b => b.status === 'Confirmed').length;
                reservationsStat.textContent = activeBookingsCount.toString().padStart(2, '0');
            }

            if (!filteredBookings || filteredBookings.length === 0) {
                let emptyMessage = 'You have no hotel bookings yet.';
                if (filterType === 'active') emptyMessage = 'You have no active hotel bookings.';
                else if (filterType === 'cancelled') emptyMessage = 'You have no cancelled hotel bookings.';
                bookingsListContainer.innerHTML = `<p class="text-muted text-center mt-4">${emptyMessage}</p>`;
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'list-unstyled';
            filteredBookings.sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));

            filteredBookings.forEach(booking => {
                const li = document.createElement('li');
                li.className = 'booking-item mb-3 p-3 border rounded shadow-sm';

                let bookingControlsHtml = '';
                if (booking.status === 'Confirmed') { // Only allow cancellation for 'Confirmed' bookings
                    if (isBookingCancellable(booking.checkInDate)) {
                        bookingControlsHtml = `<button class="btn btn-sm btn-danger mt-2 cancel-booking-btn" data-booking-ref="${booking.bookingRef}">Cancel Booking</button>`;
                    } else {
                        bookingControlsHtml = `<p class="small text-muted mt-2 mb-0">Cancellation window closed.</p>`;
                    }
                }

                const statusBadgeClass = booking.status === 'Confirmed' ? 'bg-success' :
                                         booking.status === 'Cancelled' ? 'bg-danger' :
                                         booking.status === 'Completed' ? 'bg-info text-dark' : // Badge for Completed
                                         'bg-warning text-dark'; // Default for other statuses

                let roomDetailsHtml = '';
                let roomInfoParts = [];
                if (booking.assignedRoomNumber) {
                    roomInfoParts.push(`<strong>Assigned Room:</strong> ${booking.assignedRoomNumber}`);
                }
                if (booking.roomType) {
                    roomInfoParts.push(`<strong>Room Type:</strong> ${booking.roomType}`);
                }
                if (roomInfoParts.length > 0) {
                    roomDetailsHtml = roomInfoParts.map(part => `<p class="mb-1">${part}</p>`).join('');
                } else {
                    roomDetailsHtml = `<p class="mb-1"><strong>Room Details:</strong> N/A</p>`;
                }

                li.innerHTML = `
                    ${booking.hotelImage ? `<img src="${booking.hotelImage}" alt="${booking.hotelName || 'Hotel Image'}" class="booking-hotel-image">` : ''}
                    <h6>
                        ${booking.hotelName || 'Hotel Name N/A'}
                        <span class="badge ${statusBadgeClass} float-end">${booking.status || 'N/A'}</span>
                    </h6>
                    <p class="mb-1 small text-muted">Ref: ${booking.bookingRef}</p>
                    <hr class="my-2">
                    ${roomDetailsHtml}
                    ${booking.roomImage ? `<img src="${booking.roomImage}" alt="${booking.roomType || 'Room Image'}" class="booking-room-image">` : ''}
                    <p><strong>Dates:</strong> ${formatDateForDisplay(booking.checkInDate)} - ${formatDateForDisplay(booking.checkOutDate)} (${booking.nights || 'N/A'} nights)</p>
                    <p><strong>Guest:</strong> ${booking.guestFullName || 'N/A'}</p>
                    <p><strong>Total:</strong> ₹${(booking.totalAmount || 0).toFixed(2)}</p>
                    <p class="mb-0"><strong>Booked on:</strong> ${formatDateForDisplay(booking.bookingDate)}</p>
                    ${bookingControlsHtml}
                `;
                ul.appendChild(li);
            });
            bookingsListContainer.appendChild(ul);
        }


        if (bookingsListContainer) {
            bookingsListContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('cancel-booking-btn')) {
                    const bookingRef = event.target.dataset.bookingRef;
                    if (currentUser && currentUser.email && bookingRef) { 
                        handleCancelBooking(bookingRef, currentUser.email);
                    } else {
                        alert('Error: Could not process cancellation. User session or booking details are missing.');
                    }
                }
            });
        }

        if (myBookingsLink && myBookingsModalInstance) {
            myBookingsLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (!currentUser || !currentUser.email) {
                    alert('Please log in to view your bookings.');
                    if(bookingsListContainer) bookingsListContainer.innerHTML = '<p class="text-danger text-center">Please log in to view your bookings.</p>';
                    myBookingsModalInstance.show();
                    return;
                }
                if (bookingFilterControls) {
                    bookingFilterControls.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.filter === 'all') btn.classList.add('active');
                    });
                }
                displayUserBookings(currentUser.email, 'all');
                myBookingsModalInstance.show();
            });
        }

        if (bookingFilterControls) {
            bookingFilterControls.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.filter) {
                    bookingFilterControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    if (currentUser && currentUser.email) { 
                        displayUserBookings(currentUser.email, filter);
                    }
                }
            });
        }

        // Initial display of reservation stats on page load
        // This will use the already updated booking statuses from the global call
        if (currentUser && currentUser.email && reservationsStat) {
             const userBookingsKey = `userBookings_${currentUser.email}`;
             const bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];
             // Count 'Confirmed' which now means active (not yet completed/checked-out)
             const activeBookingsCount = bookings.filter(b => b.status === 'Confirmed').length;
             reservationsStat.textContent = activeBookingsCount.toString().padStart(2, '0');
        } else if (reservationsStat) {
            reservationsStat.textContent = '00'; 
        }

        // --- Food Cart Functionality ---
        const viewCartBtn = document.getElementById('viewCartBtn');
        const foodCartModalEl = document.getElementById('foodCartModal');
        const cartItemsContainerEl = document.getElementById('cartItemsContainer');
        const cartTotalAmountEl = document.getElementById('cartTotalAmount');
        const checkoutCartButtonEl = document.getElementById('checkoutCartButton');
        const roomNumberInputEl = document.getElementById('roomNumberInput');
        let foodCartModalInstance;

        if (foodCartModalEl) {
            foodCartModalInstance = new bootstrap.Modal(foodCartModalEl);
            foodCartModalEl.addEventListener('hidden.bs.modal', function () {
                if (roomNumberInputEl) {
                    roomNumberInputEl.readOnly = false; 
                    roomNumberInputEl.value = ''; 
                }
            });
        }


        function updateCartCountBadge() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            let totalItems = 0;
            cart.forEach(item => totalItems += item.quantity);

            if (viewCartBtn) {
                let badge = viewCartBtn.querySelector('.cart-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge bg-danger rounded-pill cart-badge';
                    viewCartBtn.appendChild(badge);
                }
                if (totalItems > 0) {
                    badge.textContent = totalItems;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function displayFoodCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (!cartItemsContainerEl || !cartTotalAmountEl) return;

            cartItemsContainerEl.innerHTML = ''; 
            let totalAmount = 0;

            if (cart.length === 0) {
                cartItemsContainerEl.innerHTML = '<p class="text-center text-muted">Your food cart is empty. <a href="menu.html" class="text-primary">Order some food!</a></p>';
                cartTotalAmountEl.textContent = '0.00';
                if(checkoutCartButtonEl) checkoutCartButtonEl.disabled = true; 
                updateCartCountBadge();
                return;
            }

            if(checkoutCartButtonEl) checkoutCartButtonEl.disabled = false; 
            const table = document.createElement('table');
            table.className = 'table table-hover align-middle'; 
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Total</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
            `;
            const tbody = document.createElement('tbody');

            cart.forEach((item, index) => {
                const tr = document.createElement('tr');
                const itemTotal = item.price * item.quantity;
                totalAmount += itemTotal;
                const mealTypeDisplay = item.mealType ? ` <small class="text-muted d-block">(${item.mealType})</small>` : '';
                tr.innerHTML = `
                    <td>${item.name}${mealTypeDisplay}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-end">₹${item.price.toFixed(2)}</td>
                    <td class="text-end">₹${itemTotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger remove-cart-item-btn" data-item-index="${index}" title="Remove item">×</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            cartItemsContainerEl.appendChild(table);
            cartTotalAmountEl.textContent = totalAmount.toFixed(2);
            updateCartCountBadge();
        }

        if (cartItemsContainerEl) {
            cartItemsContainerEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-cart-item-btn')) {
                    const itemIndex = parseInt(e.target.dataset.itemIndex);
                    let cart = JSON.parse(localStorage.getItem('cart')) || [];
                    if (itemIndex >= 0 && itemIndex < cart.length) {
                        cart.splice(itemIndex, 1);
                        localStorage.setItem('cart', JSON.stringify(cart));
                        displayFoodCart(); 
                    }
                }
            });
        }

        if (viewCartBtn && foodCartModalInstance) {
            viewCartBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (roomNumberInputEl) {
                    roomNumberInputEl.readOnly = false;
                    roomNumberInputEl.value = '';
                }
                displayFoodCart();
                foodCartModalInstance.show();
            });
        }

        if (checkoutCartButtonEl) {
            checkoutCartButtonEl.addEventListener('click', function() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                if (cart.length === 0) {
                    alert('Your cart is empty. Please add items to proceed.');
                    return;
                }
                if (!currentUser || !currentUser.email) {
                    alert('Please log in to place an order.');
                    if(foodCartModalInstance) foodCartModalInstance.hide();
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                const userBookingsKey = `userBookings_${currentUser.email}`;
                const bookings = JSON.parse(localStorage.getItem(userBookingsKey)) || [];
                let activeBooking = null; 

                // Check for an active booking that covers the current date
                for (const booking of bookings) {
                    // Only consider 'Confirmed' bookings.
                    // The `updateAndRefreshBookingStatuses` function (called on page load)
                    // ensures that past 'Confirmed' bookings are marked as 'Completed'.
                    if (booking.status === 'Confirmed') {
                        const checkInDate = new Date(booking.checkInDate);
                        checkInDate.setHours(0, 0, 0, 0); // Normalize check-in date
                        const checkOutDate = new Date(booking.checkOutDate);
                        checkOutDate.setHours(0, 0, 0, 0); // Normalize check-out date

                        // Food order can be placed if 'today' is within the check-in and check-out dates (inclusive)
                        if (today >= checkInDate && today <= checkOutDate) {
                            activeBooking = booking;
                            break; // Found an active booking for today
                        }
                    }
                }

                if (!activeBooking) {
                    // If no active booking is found for the current day, prevent the order.
                    alert('Food orders can only be placed during an active hotel stay. Please ensure you have a confirmed booking for today.');
                    return; 
                }

                // If an active booking is found, proceed with order
                let roomNumber = roomNumberInputEl ? roomNumberInputEl.value.trim() : '';

                if (activeBooking.assignedRoomNumber) {
                    if (roomNumberInputEl) {
                        roomNumberInputEl.value = activeBooking.assignedRoomNumber;
                        roomNumberInputEl.readOnly = true; 
                    }
                    roomNumber = activeBooking.assignedRoomNumber;
                } else {
                     if (roomNumberInputEl) {
                        roomNumberInputEl.readOnly = false;
                    }
                }

                if (!roomNumber) {
                    alert(activeBooking.assignedRoomNumber ? 'Error fetching room number from your active booking.' : 'Please enter your room number for delivery. It seems your room has not been assigned in the system for your current booking.');
                    if (roomNumberInputEl && !activeBooking.assignedRoomNumber) roomNumberInputEl.focus();
                    return;
                }

                let orderMealType = 'General'; 
                if (cart.length > 0) {
                    const mealTypesInOrder = [...new Set(cart.map(item => item.mealType).filter(Boolean))];
                    if (mealTypesInOrder.length > 0) {
                        orderMealType = mealTypesInOrder.join(', ');
                    } else if (cart[0].mealType) {
                        orderMealType = cart[0].mealType;
                    }
                }

                const orderDetails = {
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    items: cart,
                    totalAmount: parseFloat(cartTotalAmountEl.textContent),
                    orderDate: new Date().toISOString(),
                    status: 'Placed - For Room Delivery',
                    roomNumber: roomNumber,
                    mealType: orderMealType
                };

                let userFoodOrders = JSON.parse(localStorage.getItem(`foodOrders_${currentUser.email}`)) || [];
                userFoodOrders.push(orderDetails);
                localStorage.setItem(`foodOrders_${currentUser.email}`, JSON.stringify(userFoodOrders));
                localStorage.removeItem('cart');

                alert(`Thank you, ${currentUser.name}! Your ${orderMealType} order (Total: ₹${orderDetails.totalAmount.toFixed(2)}) for Room ${roomNumber} has been placed.`);

                if (roomNumberInputEl) {
                    roomNumberInputEl.value = '';
                    roomNumberInputEl.readOnly = false;
                }
                displayFoodCart();
                if(foodCartModalInstance) foodCartModalInstance.hide();
                updateCartCountBadge();

                const ordersPlacedStatEl = document.getElementById('ordersPlacedStat');
                if (ordersPlacedStatEl) {
                    ordersPlacedStatEl.textContent = userFoodOrders.length.toString().padStart(2, '0');
                }
                if (currentUser && currentUser.email) {
                    displayRecentActivities(currentUser.email);
                }
            });
        }

        updateCartCountBadge(); 
        const ordersPlacedStat = document.getElementById('ordersPlacedStat');
        if (currentUser && currentUser.email && ordersPlacedStat) {
            let userFoodOrders = JSON.parse(localStorage.getItem(`foodOrders_${currentUser.email}`)) || [];
            ordersPlacedStat.textContent = userFoodOrders.length.toString().padStart(2, '0');
        } else if (ordersPlacedStat) {
             ordersPlacedStat.textContent = '00';
        }

        // --- Clickable Stats Cards & My Food Orders Modal ---
        const reservationsStatsCard = document.getElementById('reservationsStatsCard');
        const foodOrdersStatsCard = document.getElementById('foodOrdersStatsCard');

        const myFoodOrdersModalEl = document.getElementById('myFoodOrdersModal');
        const foodOrdersListContainerEl = document.getElementById('foodOrdersListContainer');
        let myFoodOrdersModalInstance;

        if (myFoodOrdersModalEl) {
            myFoodOrdersModalInstance = new bootstrap.Modal(myFoodOrdersModalEl);
        }

        function displayUserFoodOrders(userEmail) {
            if (!foodOrdersListContainerEl) return;

            foodOrdersListContainerEl.innerHTML = ''; 
             if (!userEmail) {
                foodOrdersListContainerEl.innerHTML = '<p class="text-danger text-center">User not identified. Please log in.</p>';
                return;
            }
            const userFoodOrdersKey = `foodOrders_${userEmail}`;
            const allFoodOrders = JSON.parse(localStorage.getItem(userFoodOrdersKey)) || [];

            if (!allFoodOrders || allFoodOrders.length === 0) {
                foodOrdersListContainerEl.innerHTML = `<p class="text-muted text-center mt-4">You have no food orders yet.</p>`;
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'list-unstyled';
            allFoodOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            allFoodOrders.forEach(order => {
                const li = document.createElement('li');
                li.className = 'mb-3 p-3 border rounded shadow-sm';

                let itemsHtml = '<ul class="list-unstyled ms-3 mt-1 small">';
                order.items.forEach(item => {
                    const itemMealInfo = item.mealType ? ` (${item.mealType})` : '';
                    itemsHtml += `<li>${item.quantity} x ${item.name}${itemMealInfo} (₹${item.price.toFixed(2)} each)</li>`;
                });
                itemsHtml += '</ul>';

                const statusBadgeClass = order.status && order.status.toLowerCase().includes('delivered') ? 'bg-success' :
                                         order.status && order.status.toLowerCase().includes('cancelled') ? 'bg-danger' :
                                         order.status && order.status.toLowerCase().includes('placed') ? 'bg-info text-dark' : 'bg-secondary'; 

                const roomInfo = order.roomNumber ? `<p class="mb-1"><strong>Deliver to Room:</strong> ${order.roomNumber}</p>` : '';
                const mealTypeInfo = order.mealType ? `<p class="mb-1"><strong>Meal Type(s):</strong> ${order.mealType}</p>` : '';

                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <h6>Order Placed: ${formatDateForDisplay(order.orderDate)}</h6>
                        <span class="badge ${statusBadgeClass}">${order.status || 'N/A'}</span>
                    </div>
                    <hr class="my-2">
                    ${roomInfo}
                    ${mealTypeInfo}
                    <p class="mb-1"><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <div><strong>Items:</strong>${itemsHtml}</div>
                `;
                ul.appendChild(li);
            });
            foodOrdersListContainerEl.appendChild(ul);
        }

        if (reservationsStatsCard && myBookingsModalInstance) {
            reservationsStatsCard.addEventListener('click', function() {
                if (!currentUser || !currentUser.email) {
                    alert('Please log in to view your bookings.');
                    return;
                }
                if (bookingFilterControls) {
                    bookingFilterControls.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.filter === 'active') btn.classList.add('active');
                    });
                }
                displayUserBookings(currentUser.email, 'active');
                myBookingsModalInstance.show();
            });
        }

        if (foodOrdersStatsCard && myFoodOrdersModalInstance) {
            foodOrdersStatsCard.addEventListener('click', function() {
                if (!currentUser || !currentUser.email) {
                    alert('Please log in to view your food orders.');
                    return;
                }
                displayUserFoodOrders(currentUser.email);
                myFoodOrdersModalInstance.show();
            });
        }

        // Initial load for recent activities and loyalty points
        // These will use the already updated booking statuses from the global call
        if (currentUser && currentUser.email) {
            displayRecentActivities(currentUser.email);
            calculateAndDisplayLoyaltyPoints(currentUser.email);
        } else {
            displayRecentActivities(null); 
            calculateAndDisplayLoyaltyPoints(null); 
        }

        // --- Payment Methods Feature ---
        const paymentMethodsOffcanvasEl = document.getElementById('paymentMethodsOffcanvas');

        const paymentTypeSelectionContainerEl = document.getElementById('paymentTypeSelectionContainer');
        const creditCardManagementContainerEl = document.getElementById('creditCardManagementContainer');
        const otherPaymentMethodPlaceholderEl = document.getElementById('otherPaymentMethodPlaceholder');

        const savedPaymentMethodsContainerEl = document.getElementById('savedPaymentMethodsContainer');
        const showAddPaymentMethodFormBtnEl = document.getElementById('showAddPaymentMethodFormBtn');
        const addPaymentMethodFormContainerEl = document.getElementById('addPaymentMethodFormContainer');
        const addPaymentMethodFormEl = document.getElementById('addPaymentMethodForm');
        const cancelAddPaymentMethodBtnEl = document.getElementById('cancelAddPaymentMethodBtn');
        const cardholderNameInput = document.getElementById('cardholderName');
        const cardNumberInput = document.getElementById('cardNumber');
        const cardExpiryInput = document.getElementById('cardExpiry');
        const cardCvvInput = document.getElementById('cardCvv');

        const offcanvasDynamicTitleEl = document.getElementById('offcanvasDynamicTitle');
        const backToPaymentTypesBtnEl = document.getElementById('backToPaymentTypesBtn');

        const otherPaymentMethodTitleEl = document.getElementById('otherPaymentMethodTitle');
        const otherPaymentMethodIconEl = document.getElementById('otherPaymentMethodIcon');

        if (paymentMethodsOffcanvasEl) {
            paymentMethodsOffcanvasEl.addEventListener('show.bs.offcanvas', function () {
                paymentTypeSelectionContainerEl.style.display = 'block';
                creditCardManagementContainerEl.style.display = 'none';
                otherPaymentMethodPlaceholderEl.style.display = 'none';

                offcanvasDynamicTitleEl.textContent = 'Select Payment Method';
                backToPaymentTypesBtnEl.classList.add('d-none');

                addPaymentMethodFormContainerEl.style.display = 'none';
                if(addPaymentMethodFormEl) addPaymentMethodFormEl.reset();
                if(showAddPaymentMethodFormBtnEl) showAddPaymentMethodFormBtnEl.style.display = 'block';

                if (!currentUser || !currentUser.email) {
                    paymentTypeSelectionContainerEl.innerHTML = `<p class="text-danger text-center py-3">Please log in to manage or use payment methods.</p>`;
                } else {
                    if (!paymentTypeSelectionContainerEl.querySelector('.list-group')) {
                        paymentTypeSelectionContainerEl.innerHTML = `
                            <p class="mb-3">Choose how you'd like to pay or manage your payment options:</p>
                            <div class="list-group">
                                <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="cards">
                                    <i class="fas fa-credit-card me-2 text-primary"></i> Credit/Debit Cards
                                    <small class="d-block text-muted mt-1">Manage your saved cards or add a new one.</small>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="upi">
                                    <i class="bi bi-lightning-charge-fill me-2" style="color: #57398E;"></i> UPI
                                    <small class="d-block text-muted mt-1">Pay directly using UPI ID (e.g., GPay, PhonePe).</small>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="netbanking">
                                    <i class="fas fa-university me-2" style="color: #28a745;"></i> Net Banking
                                    <small class="d-block text-muted mt-1">Use your internet banking facility.</small>
                                </a>
                                <a href="#" class="list-group-item list-group-item-action payment-type-option" data-payment-type="wallets">
                                    <i class="fas fa-wallet me-2" style="color: #DD3682;"></i> Digital Wallets
                                    <small class="d-block text-muted mt-1">Pay with popular mobile wallets (e.g., Paytm).</small>
                                </a>
                            </div>`;
                    }
                }
            });

            paymentMethodsOffcanvasEl.addEventListener('click', function(event) {
                const target = event.target.closest('.payment-type-option');
                if (target) {
                    event.preventDefault();
                    if (!currentUser || !currentUser.email) {
                        alert('Please log in to access payment methods.');
                        return;
                    }

                    const paymentType = target.dataset.paymentType;

                    paymentTypeSelectionContainerEl.style.display = 'none';
                    backToPaymentTypesBtnEl.classList.remove('d-none');

                    if (paymentType === 'cards') {
                        creditCardManagementContainerEl.style.display = 'block';
                        otherPaymentMethodPlaceholderEl.style.display = 'none';
                        offcanvasDynamicTitleEl.textContent = 'Manage Credit/Debit Cards';
                        loadUserPaymentMethods(currentUser.email);
                        addPaymentMethodFormContainerEl.style.display = 'none';
                        if(showAddPaymentMethodFormBtnEl) showAddPaymentMethodFormBtnEl.style.display = 'block';
                        if(addPaymentMethodFormEl) addPaymentMethodFormEl.reset();

                    } else { 
                        creditCardManagementContainerEl.style.display = 'none';
                        otherPaymentMethodPlaceholderEl.style.display = 'block';
                        let title = 'Payment Option';
                        let iconClass = 'fas fa-cogs text-muted'; 

                        if (paymentType === 'upi') {
                            title = 'UPI Payment';
                            iconClass = 'bi bi-lightning-charge-fill display-4 mb-3'
                            if(otherPaymentMethodIconEl) otherPaymentMethodIconEl.style.color = '#57398E'; 
                        } else if (paymentType === 'netbanking') {
                            title = 'Net Banking';
                            iconClass = 'fas fa-university display-4 mb-3';
                            if(otherPaymentMethodIconEl) otherPaymentMethodIconEl.style.color = '#28a745'; 
                        } else if (paymentType === 'wallets') {
                            title = 'Digital Wallets';
                            iconClass = 'fas fa-wallet display-4 mb-3';
                            if(otherPaymentMethodIconEl) otherPaymentMethodIconEl.style.color = '#DD3682'; 
                        }
                        if(offcanvasDynamicTitleEl) offcanvasDynamicTitleEl.textContent = title;
                        if(otherPaymentMethodTitleEl) otherPaymentMethodTitleEl.textContent = title;
                        if(otherPaymentMethodIconEl) otherPaymentMethodIconEl.className = iconClass;
                    }
                }
            });
        }

        if (backToPaymentTypesBtnEl) {
            backToPaymentTypesBtnEl.addEventListener('click', function() {
                if(paymentTypeSelectionContainerEl) paymentTypeSelectionContainerEl.style.display = 'block';
                if(creditCardManagementContainerEl) creditCardManagementContainerEl.style.display = 'none';
                if(otherPaymentMethodPlaceholderEl) otherPaymentMethodPlaceholderEl.style.display = 'none';

                if(offcanvasDynamicTitleEl) offcanvasDynamicTitleEl.textContent = 'Select Payment Method';
                this.classList.add('d-none'); 
            });
        }

        if (showAddPaymentMethodFormBtnEl) {
            showAddPaymentMethodFormBtnEl.addEventListener('click', function() {
                if(addPaymentMethodFormContainerEl) addPaymentMethodFormContainerEl.style.display = 'block';
                this.style.display = 'none'; 
            });
        }

        if (cancelAddPaymentMethodBtnEl) {
            cancelAddPaymentMethodBtnEl.addEventListener('click', function() {
                if(addPaymentMethodFormContainerEl) addPaymentMethodFormContainerEl.style.display = 'none';
                if(addPaymentMethodFormEl) addPaymentMethodFormEl.reset();
                if(showAddPaymentMethodFormBtnEl) showAddPaymentMethodFormBtnEl.style.display = 'block'; 
            });
        }

        function getCardType(cardNumber) {
            const cleanedCardNumber = cardNumber.replace(/\s/g, '');
            if (/^4[0-9]{12}(?:[0-9]{3})?$/.test(cleanedCardNumber)) return 'Visa';
            if (/^5[1-5][0-9]{14}$/.test(cleanedCardNumber)) return 'Mastercard';
            if (/^3[47][0-9]{13}$/.test(cleanedCardNumber)) return 'American Express';
            if (/^6(?:011|5[0-9]{2})[0-9]{12}$/.test(cleanedCardNumber)) return 'Discover';
            return 'Generic'; 
        }

        function maskCardNumber(cardNumber) {
            const visibleDigits = 4;
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            if (cleanCardNumber.length <= visibleDigits) {
                return cleanCardNumber; 
            }
            return `**** **** **** ${cleanCardNumber.slice(-visibleDigits)}`;
        }

        if (addPaymentMethodFormEl) {
            addPaymentMethodFormEl.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!currentUser || !currentUser.email) {
                    alert('Error: User session not found. Please log in again.');
                    return;
                }

                const cardholderName = cardholderNameInput.value.trim();
                const cardNumberRaw = cardNumberInput.value;
                const cardNumberClean = cardNumberRaw.replace(/\s/g, ''); 
                const cardExpiry = cardExpiryInput.value.trim();
                const cardCvv = cardCvvInput.value.trim();

                if (!cardholderName) {
                    alert('Please enter the cardholder name.');
                    cardholderNameInput.focus();
                    return;
                }
                if (cardNumberClean.length < 13 || cardNumberClean.length > 19 || !/^\d+$/.test(cardNumberClean)) {
                    alert('Please enter a valid card number (13-19 digits).');
                    cardNumberInput.focus();
                    return;
                }
                if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(cardExpiry)) {
                    alert('Please enter a valid expiry date in MM/YY format (e.g., 03/25).');
                    cardExpiryInput.focus();
                    return;
                }
                const [expMonth, expYearSuffix] = cardExpiry.split('/');
                const expYear = parseInt(`20${expYearSuffix}`);
                const expMonthNum = parseInt(expMonth);
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth() + 1; 

                if (expYear < currentYear || (expYear === currentYear && expMonthNum < currentMonth)) {
                    alert('Card expiry date cannot be in the past.');
                    cardExpiryInput.focus();
                    return;
                }

                if (cardCvv.length < 3 || cardCvv.length > 4 || !/^\d+$/.test(cardCvv)) {
                    alert('Please enter a valid CVV (3 or 4 digits).');
                    cardCvvInput.focus();
                    return;
                }

                const paymentMethodsKey = `paymentMethods_${currentUser.email}`;
                let paymentMethods = JSON.parse(localStorage.getItem(paymentMethodsKey)) || [];

                const newPaymentMethod = {
                    id: Date.now().toString(), 
                    cardholderName: cardholderName,
                    cardNumberMasked: maskCardNumber(cardNumberClean),
                    cardType: getCardType(cardNumberClean),
                    expiryDate: cardExpiry,
                };

                paymentMethods.push(newPaymentMethod);
                localStorage.setItem(paymentMethodsKey, JSON.stringify(paymentMethods));

                alert('Payment method added successfully!');
                loadUserPaymentMethods(currentUser.email); 
                addPaymentMethodFormEl.reset();
                if(addPaymentMethodFormContainerEl) addPaymentMethodFormContainerEl.style.display = 'none';
                if(showAddPaymentMethodFormBtnEl) showAddPaymentMethodFormBtnEl.style.display = 'block';
            });
        }

        function loadUserPaymentMethods(userEmail) {
            if (!savedPaymentMethodsContainerEl) return;

            const paymentMethodsKey = `paymentMethods_${userEmail}`;
            const paymentMethods = JSON.parse(localStorage.getItem(paymentMethodsKey)) || [];

            savedPaymentMethodsContainerEl.innerHTML = ''; 

            if (paymentMethods.length === 0) {
                savedPaymentMethodsContainerEl.innerHTML = '<p class="text-muted text-center py-3">No payment methods saved yet.</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'list-group list-group-flush'; 

            paymentMethods.forEach(method => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                let cardIconClass = 'fa-credit-card'; 
                let iconColor = '#FEA116'; 
                if (method.cardType === 'Visa') { cardIconClass = 'fa-cc-visa'; iconColor = '#1A1F71'; }
                else if (method.cardType === 'Mastercard') { cardIconClass = 'fa-cc-mastercard'; iconColor = '#EB001B'; }
                else if (method.cardType === 'American Express') { cardIconClass = 'fa-cc-amex'; iconColor = '#2E77BC'; }
                else if (method.cardType === 'Discover') { cardIconClass = 'fa-cc-discover'; iconColor = '#FF6600';}

                li.innerHTML = `
                    <div>
                        <i class="fab ${cardIconClass} fa-2x me-3 align-middle" style="color: ${iconColor};"></i>
                        <span>
                            <span class="fw-bold d-block">${method.cardholderName}</span>
                            ${method.cardNumberMasked} <br>
                            <small class="text-muted">Expires: ${method.expiryDate}</small>
                        </span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger delete-payment-method-btn" data-method-id="${method.id}" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                ul.appendChild(li);
            });
            savedPaymentMethodsContainerEl.appendChild(ul);
        }

        if (savedPaymentMethodsContainerEl) {
            savedPaymentMethodsContainerEl.addEventListener('click', function(event) {
                const deleteButton = event.target.closest('.delete-payment-method-btn');
                if (deleteButton) {
                    if (!currentUser || !currentUser.email) {
                        alert('Error: User session not found.');
                        return;
                    }
                    const methodIdToDelete = deleteButton.dataset.methodId;
                    if (confirm('Are you sure you want to delete this payment method?')) {
                        deleteUserPaymentMethod(currentUser.email, methodIdToDelete);
                    }
                }
            });
        }

        function deleteUserPaymentMethod(userEmail, methodId) {
            const paymentMethodsKey = `paymentMethods_${userEmail}`;
            let paymentMethods = JSON.parse(localStorage.getItem(paymentMethodsKey)) || [];

            paymentMethods = paymentMethods.filter(method => method.id !== methodId);
            localStorage.setItem(paymentMethodsKey, JSON.stringify(paymentMethods));

            alert('Payment method deleted.');
            loadUserPaymentMethods(userEmail); 
        }

        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, ''); 
                let formattedValue = '';
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                e.target.value = formattedValue.substring(0, 19); 
            });
        }

        if (cardExpiryInput) {
            cardExpiryInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, ''); 

                if (value.length > 2 && !e.target.value.includes('/')) {
                    if (e.inputType === 'insertText' || e.inputType === 'insertCompositionText') {
                         value = value.substring(0, 2) + '/' + value.substring(2);
                    }
                }

                if (value.includes('/')) {
                    const parts = value.split('/');
                    let month = parts[0];
                    let year = parts[1] || '';
                    value = month.substring(0,2) + '/' + year.substring(0,2);
                } else if (value.length > 2) {
                     value = value.substring(0, 2) + '/' + value.substring(2, 4);
                } else {
                     value = value.substring(0,2);
                }

                e.target.value = value.substring(0, 5); 
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const viewAction = urlParams.get('view');

        if (viewAction === 'cart') {
            if (foodCartModalInstance && typeof displayFoodCart === 'function') {
                if (roomNumberInputEl) { 
                    roomNumberInputEl.readOnly = false;
                    roomNumberInputEl.value = '';
                }
                displayFoodCart(); 
                foodCartModalInstance.show(); 
            } else {
                console.warn('Food cart modal or display function not available to auto-show for ?view=cart.');
            }
        }
        
        const spinner = document.getElementById('spinner');
        if (spinner && spinner.classList.contains('show')) {
            setTimeout(function() {
                spinner.classList.remove('show');
            }, 500); 
        }
    });
    </script>

</body>
</html>